<!-- This is Lorenzo Beltrame assignment submission for the fifth
programming assignment for the VIS 2022S 05.06.22 -->
<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" type="text/css" href="main.css">
  <script src="d3.min.js"></script>
  <script src="jquery-3.6.0.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous"></script>

  <title> A5 assignment visualization </title>
</head>
<body style="background-color:#e8e2e1;">


<h1 style="color:red;"> Covid-19 visualization  </h1>


<div class=class="container-fluid" id="big_container">
 <div class="row" style="background-color:#969892;">
   <div>
       <label for="start">Start date:</label>
       <input type="date" id="date_start" name="start_time"
              value="2020-03-01"
              min="2020-01-01" max="2022-12-30"
              onchange="get_start_dates()">

       <label for="start">End date:</label>

       <input type="date" id="date_end" name="end_time"
              value="2021-03-01"
              min="2020-01-02" max="2022-12-31">
 </div>
 <div class="row">
   <svg class="col-7" id="choosing_barplot" style="background-color:#e8e2e1;">
   </svg>
   <div class="col-sm" id="choosing_table" style="background-color:#e8e2e1;">
   </div>
  </div>
  </div>
</div>




<div id="table" style="position:absolute; left:850px; top:170px;"></div>


<! Load the data using D3 and insert the labels in the graph >
<script>





    // data
    Promise.all([
      d3.csv('Final_df.csv'),
      d3.csv('Continent_grouped.csv'),
      d3.csv('countries_grouped.csv')
    ]).then(([data, continet_data, countries_data]) => {

      // date management
      var day_end, day_start, month_end, month_start, year_end, year_start;
      var data_start, data_end, data_table;
      // table management
      var table;
      var active_continent, my_active_data;
      // plot management
      var continent_view, go_to_second_view;


      continent_view = true;
      d3.select("#date_end").node().oninput = get_end_dates



      // preprocessing
      continet_data = continet_data.filter(
        d => d.continent.length > 0)

      countries_data = countries_data.filter(
        d => d.location.length > 0)

      continet_data.forEach(d => {
        d.year = +d["year"];
        d.month = +d["month"];
        d.day = +d["day"];
        d.Percentage = +d["Percentage"];
      })

      countries_data.forEach(d => {
        d.year = +d["year"];
        d.month = +d["month"];
        d.day = +d["day"];
        d.Percentage = +d["Percentage"];
      })

      // get the variables from the selector
      get_end_dates();
      get_start_dates();



      // acquire dates
      function get_start_dates() {
        date_start=$('#date_start').val().split('-');
        day_start=+date_start[2];
        month_start=+date_start[1];
        year_start=+date_start[0];
        data_start = data.filter(d => day_start == d.day   &&
                                  month_start == d.month   &&
                                  year_start == d.year )

        data_table = [data_start, data_end]
        refresh();
      }

      function get_end_dates() {
        date_end=$('#date_end').val().split('-');
        day_end=+date_end[2];
        month_end=+date_end[1];
        year_end=+date_end[0];

        data_end = data.filter(d => day_end == d.day   &&
                                  month_end == d.month   &&
                                  year_end == d.year )

        data_table = [data_start, data_end]
        refresh();
      }


      function print_barplot() {
        // util flag
        continent_view = true

        // set the dimensions and margins of the graph
        var margin = {top: 100, right: 100, bottom: 200, left: 100},
            width = 1000 - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#choosing_barplot")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr('id', "to_be_deleted_1")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");


        // X axis
        var x = d3.scaleBand()
          .range([ 0, width - margin.left])
          .domain(continet_data.map(function(d) { return d.continent; }))
          .padding(0.2);

        var rectangle = svg.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 1000)
          .attr('fill', '#e8e2e1')
          .attr("height", 500)
          .attr('id', 'to_be_deleted_final_1')
          .on('click', go_back_to_continent )


        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "15")
            .style("font-weight","bold")
            .attr('id', "to_be_deleted_1");

        // Add Y axis
        // compute the max
        let data_end_day = continet_data.filter(d => day_end == d.day       &&
                                                     month_end == d.month   &&
                                                     year_end == d.year )
        let my_max = d3.max(data_end_day.map(d => d.Percentage))
        console.log(my_max);
        var y = d3.scaleLinear()
          .domain([0, my_max])
          .range([ height, 0]);

        svg.append("g")
          .attr('id', 'to_be_deleted_1')
          .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
          .attr('id', "to_be_deleted_1")
          .data(data_end_day)
          .enter()
          .append("rect")
            .attr('class', 'barplot')
            .attr("x", function(d) { return x(d.continent); })
            .attr("y", function(d) { return y(d.Percentage);})
            .attr("width", x.bandwidth())
            .attr('id', function(d) { return d.continent})
            .attr("height", function(d) { return height - y(d.Percentage); })
            .attr("fill", "#f05d98")
            .on("mouseover", function() {
                d3.select(this).style("fill", "#bf303d");
              })
            .on("mouseout", function() {
                d3.select(this).style("fill", "#f05d98");
              })
            .on("click", continent_to_countries)

            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr('id', 'to_be_deleted_1')
                .attr("y", 6)
                .attr("dy", "-3em")
                .attr("x", 30)
                .attr("dx", "-11em")
                .attr("transform", "rotate(-90)")
                .text("Percentage of covid cases")
                .style("font-weight","bold");

            svg.append("text")
                .text("Shares of covid cases on the last day selected: ")
                .attr("y", - 20)
                .attr('id', "to_be_deleted_1")
                .attr("x", 370)
                .attr('text-anchor', 'middle')
                .style("font-weight","bold");
        }


        function print_barplot_countries(active_data) {
          // set the dimensions and margins of the graph
          var margin = {top: 100, right: 100, bottom: 200, left: 100},
              width = 1000 - margin.left - margin.right,
              height = 800 - margin.top - margin.bottom;

          // append the svg object to the body of the page
          var svg = d3.select("#choosing_barplot")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr('id', 'to_be_deleted_2')
              .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");


          // X axis
          var x = d3.scaleBand()
            .range([ 0, width - margin.left])
            .domain(active_data.map(function(d) { return d.location; }))
            .padding(0.2);
          svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .selectAll("text")
              .attr("transform", "translate(-10,0)rotate(-45)")
              .style("text-anchor", "end")
              .style("font-size", "12")
              .style("font-weight","bold");


          var rectangle = svg.append("rect")
            .attr("x", 0)
            .attr("y", 0)
            .attr("width", 1000)
            .attr('fill', '#e8e2e1')
            .attr("height", 500)
            .attr('id', 'to_be_deleted_final_1')
            .on('click', go_back_to_continent )

          // Add Y axis
          // compute the max
          let data_end_day = active_data.filter(d => day_end == d.day       &&
                                                     month_end == d.month   &&
                                                     year_end == d.year )
          let my_max = d3.max(data_end_day.map(d => d.Percentage))
          var y = d3.scaleLinear()
            .domain([0, my_max])
            .range([ height, 0]);

          svg.append("g")
            .attr('id', 'to_be_deleted_2')
            .call(d3.axisLeft(y));

          // Bars
          svg.selectAll("mybar")
            .data(data_end_day)
            .enter()
            .append("rect")
              .attr("x", function(d) { return x(d.location); })
              .attr("y", function(d) { return y(d.Percentage);})
              .attr('class', 'barplot')
              .attr("width", x.bandwidth())
              .attr('id', function(d) { return d.location})
              .attr("height", function(d) { return height - y(d.Percentage); })
              .attr("fill", "#f05d98")
              .on("mouseover", function() {
                  d3.select(this).style("fill", "#bf303d");
                })
              .on("mouseout", function() {
                  d3.select(this).style("fill", "#f05d98");
                })
              .on("click", add_country)

              svg.append("text")
                  .attr("class", "y label")
                  .attr("text-anchor", "end")
                  .attr('id', 'to_be_deleted_2')
                  .attr("y", 6)
                  .attr("dy", "-3em")
                  .attr("x", 30)
                  .attr("dx", "-11em")
                  .attr("transform", "rotate(-90)")
                  .text("Percentage of covid cases")
                  .style("font-weight","bold");

              svg.append("text")
                  .text("Shares of covid cases on the last day selected: ")
                  .attr("y", -20)
                  .attr("x", 370)
                  .attr('text-anchor', 'middle')
                  .style("font-weight","bold");
          }

        table = d3.select('#choosing_table').append('table');
        var headers = ["Country", "Percentage positives", "Vaccines"];

        // create the headers
        table.create_struct = function() {
          table.append("thead").append("tr")
              .selectAll("th")
              .data(headers)
              .enter().append("th")
              .text(function(d) {
                return d;
              })
              .style("padding", "5px")
              .style("background-color", "lightgrey");
        }

        // Reset the table
        table.reset = function() {
          // recreate the structure
          table.selectAll("tr").remove()
          table.create_struct();

            first_click = true
        }

        table.reset();

        function refresh(){
            if (continent_view) {
              console.log("sfdsfsdfsdf");
              d3.selectAll("#to_be_deleted_1").remove();
              d3.selectAll("#to_be_deleted_2").remove();
              print_barplot(continet_data);
            } else {
              d3.selectAll("#to_be_deleted_1").remove();
              d3.selectAll("#to_be_deleted_2").remove();
              print_barplot_countries(chosen_continent_data);
            }
        }

        function continent_to_countries() {
            active_continent = this.id
            new_view = true
            d3.selectAll("#to_be_deleted_1").remove();
            chosen_continent_data = countries_data.filter(
                d => d.continent == active_continent
            )
            continent_view = false
            print_barplot_countries(chosen_continent_data)

        }

  function add_country(){
      let add_end = chosen_continent_data.filter(d => day_end == d.day  &&
                                                 month_end == d.month   &&
                                                 year_end == d.year)
      var selected_data = add_end.filter(d => this.id == d.location)
      if (first_click) {
        table.selectAll("tr").remove();
        table.create_struct();
          // data
          let line = table.append("tbody")
            .selectAll("tr")
            .data(selected_data)
            .enter()
            .append("tr")
            // Highlighting of the line on mouseover
            .on("mouseover", function() {
                d3.select(this).style("background-color", "pink");
              })
            .on("mouseout", function() {
                d3.select(this).style("background-color", "transparent");
            })

            //fill the lines with content
            line.append("td") //Name Cell
              .text(d => d["location"])
            line.append("td") //Size Cell
              .text(d => String(d.Percentage.toFixed(2)) + " %")
            line.append("td") //Weight Cell
              .text(d => String(d.total_vaccinations))

            first_click = false;


      } else {
        // data
        let line = table.append("tbody")
          .selectAll("tr")
          .data(selected_data)
          .enter()
          .append("tr")
          // Highlighting of the line on mouseover
          .on("mouseover", function() {
              d3.select(this).style("background-color", "pink");
            })
          .on("mouseout", function() {
              d3.select(this).style("background-color", "transparent");
          })

          //fill the lines with content
          line.append("td") //Name Cell
            .text(d => d["location"])
          line.append("td") //Size Cell
            .text(d => String(d.Percentage.toFixed(2)) + " %")
          line.append("td") //Weight Cell
            .text(d => String(d.total_vaccinations))

      }
    }


      function countries_to_continent() {
        active_continent = "None"
        new_view = false
        d3.selectAll("to_be_deleted_2").remove()
        print_barplot(continet_data)
        d3.selectAll("#to_be_deleted_1").remove();
      }

        function go_back_to_continent(){
          continent_view = true
          refresh()
        }

  })






    var first_click = true


    // function that assigns a colour to each state
    function colour_generator_BA(d, colour_scale) {
      return d3.hsl(11, 0.7, colour_scale(d))
    }


</script>




<style>
  svg{
    width:650;
    height:400;
  }
  .line-class{
    stroke: lightgrey;
    stroke-width: 2;
  }

  .line-info{
    stroke: lightgrey;
    stroke-width: 0.5;
  }
 </style>


</body>
</html>

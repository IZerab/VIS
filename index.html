<!-- This is Lorenzo Beltrame assignment submission for the fifth
programming assignment for the VIS 2022S 05.06.22 -->
<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="main.css">
    <script src="d3.min.js"></script>
    <script src="jquery-3.6.0.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.17/js/bootstrap-select.min.js"></script>
  <title> A5 assignment visualization </title>
</head>
<body style="background-color:#e8e2e1;">


<h1 style="color:red;"> Covid-19 visualization  </h1>


<div class=class="container-fluid" id="big_container_1">
    <div class="row align-items-center" style="background-color:#969892;">
      <div class="row justify-content-sm-center" style="background-color:#e8e2e1;" >
          <div class="col-md-auto" >
        <label for="start">Start date:</label>
        <input type="date" id="date_start" name="start_time"
               value="2020-03-01"
               min="2020-01-01" max="2022-12-30"
               onchange="get_start_dates()">
      </div>
          <div class="col-md-auto" >
        <label for="start">End date:</label>

        <input type="date" id="date_end" name="end_time"
               value="2021-03-01"
               min="2020-01-02" max="2022-12-31">
      </div>
          <div class="col-md-auto">
              <button type="button" class="btn btn-sm btn-block h-100 btn-outline-primary" data-toggle="modal" id="compare_button" sleepTime=100>Compare</button>
      </div>
      </div>

    </div>

    <div class="row" style="background-color:#e8e2e1;">
       <div class="col">
           <svg class="row-7" id="choosing_barplot" style="background-color:#e8e2e1;"></svg>
       </div>
       <div class="col">
           <div class="row-sm" id="choosing_table" style="background-color:#e8e2e1;"></div>
       </div>
    </div>
</div>

<div class=class="container-fluid" id="big_container_2">
  <div class="row justify-content-sm-center" style="background-color:#e8e2e1;" >
      <div class="col-md-auto" id="date1"></div>
      <div class="col-md-auto" id="date2"></div>
      <div class="col-md-auto" id="back"></div>
  </div>

  <div class="row">
      <svg class="col-lg-6" style="background-color:#e8e2e1;" id="vis1"></svg>
      <div class="col-lg-6" style="background-color:#e8e2e1;">
        <div id="selector_space_vis_2"></div>
        <div class="col-lg-6" id="vis2"></div>
      </div>
  </div>

  <div class="row">
      <div class="col-lg-6" style="background-color:#e8e2e1;">
        <div id="selector_space_vis_3"></div>
        <div class="col-lg-6" id="vis3"></div>
      </div>
      <div class="col-lg-6" style="background-color:#e8e2e1;" id="vis4"></div>
  </div>
</div>



<! Load the data using D3 and insert the labels in the graph >
<script>

    // data
    Promise.all([
      d3.csv('Final_df.csv'),
      d3.csv('Continent_grouped.csv'),
      d3.csv('countries_grouped.csv'),
      d3.csv("countries_grouped_health.csv"),
      d3.json('world.geo.json')
    ]).then(([data, continet_data, countries_data, health_data, geodata]) => {

      // date management
      var day_end, day_start, month_end, month_start, year_end, year_start;
      var data_start, data_end, data_table, date_start_whole, date_end_whole;
      // table management
      var table, vect_double;
      var active_continent, my_active_data;
      var max_countries
      // plot management
      var continent_view, go_to_second_view, second_view_data;
      var features_vis_2, click;
      var myColours, second_view_flag;

      // Ordinal color map
      myColours = [ "#be6043", "#a9594b", "#de4065", "#eacfac", "#1f7d7a", "#0754fa", "#f50c2b", "#b4b4ca", "#504048", "#623122"];

      // preprocessing
      continet_data = continet_data.filter(
        d => d.continent.length > 0)

      countries_data = countries_data.filter(
        d => d.location.length > 0)

      continet_data.forEach(d => {
        d.year = +d["year"];
        d.month = +d["month"];
        d.day = +d["day"];
        d.Percentage = +d["Percentage"];
        d.Percentage_vaccines = +d["Percentage_vaccines"];
      })

      countries_data.forEach(d => {
        d.year = +d["year"];
        d.month = +d["month"];
        d.day = +d["day"];
        d.Percentage = +d["Percentage"];
        d.Percentage_vaccines = +d["Percentage_vaccines"];
        d.total_cases = +d["total_cases"];
        d.new_cases = +d["new_cases"];
        d.total_vaccinations = +d["total_vaccinations"];
        d.total_tests = +d["total_tests"];
        d.new_tests = +d["new_tests"];
        d.population = +d["population"];
        d.people_vaccinated = +d["people_vaccinated"];
        d.location = d["location"];
        d.complete_dates = d["complete_dates"];
      })

      features_vis_2 = ["total_cases", "new_cases", "total_vaccinations", "total_tests", "new_tests", "Percentage", "Percentage_vaccines", "people_vaccinated"]
      features_vis_3 = ['human_development_index','population_density','median_age','aged_65_older','aged_70_older','gdp_per_capita','extreme_poverty','cardiovasc_death_rate','diabetes_prevalence']


      function first_view(){
        vect_double = []
        max_countries = 0


        continent_view = true;
        d3.select("#date_end").node().oninput = get_end_dates

        // Initialise the table
        initialize_table();
        table.reset();
        // get the variables from the selector
        initialization = true
        get_end_dates();
        get_start_dates();
        initialization = false
      }
      first_view();

      // acquire dates
      function get_start_dates() {
        date_start=$('#date_start').val().split('-');
        date_start_whole = $('#date_start').val();
        day_start=+date_start[2];
        month_start=+date_start[1];
        year_start=+date_start[0];
        data_start = data.filter(d => day_start == d.day   &&
                                  month_start == d.month   &&
                                  year_start == d.year )

        data_table = [data_start, data_end]
        if (second_view_flag == true){
          update_vis_2();
          print_barplot_2();
        }
        update_dates();
      }

      function get_end_dates() {
        date_end=$('#date_end').val().split('-');
        date_end_whole = $('#date_end').val();
        day_end=+date_end[2];
        month_end=+date_end[1];
        year_end=+date_end[0];

        data_end = data.filter(d => day_end == d.day     &&
                                  month_end == d.month   &&
                                  year_end == d.year )

        data_table = [data_start, data_end]
        if (second_view_flag == true){
          update_vis_2();
          print_barplot_2();
          let add_end = countries_data.filter(d => day_end == d.day  &&
                                                     month_end == d.month   &&
                                                     year_end == d.year)
          second_view_data = add_end.filter(d => vect_double.includes(d["location"]))
        }
        update_dates();
      }

      function print_barplot() {
        // util flag
        continent_view = true

        // set the dimensions and margins of the graph
        var margin = {top: 100, right: 100, bottom: 200, left: 100},
            width = 1000 - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#choosing_barplot")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr('id', "to_be_deleted_1")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");


        // X axis
        var x = d3.scaleBand()
          .range([ 0, width - margin.left])
          .domain(continet_data.map(function(d) { return d.continent; }))
          .padding(0.2);

        var rectangle = svg.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 1000)
          .attr('fill', '#e8e2e1')
          .attr("height", 500)
          .attr('id', 'to_be_deleted_final_1')
          .on('click', go_back_to_continent )

        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "15")
            .style("font-weight","bold")
            .attr('id', "to_be_deleted_1");

        // Add Y axis
        // compute the max
        let data_end_day = continet_data.filter(d => day_end == d.day       &&
                                                     month_end == d.month   &&
                                                     year_end == d.year )
        let my_max = d3.max(data_end_day.map(d => d.Percentage))
        var y = d3.scaleLinear()
          .domain([0, my_max + 1])
          .range([ height, 0]);

        svg.append("g")
          .attr('id', 'to_be_deleted_1')
          .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
          .attr('id', "to_be_deleted_1")
          .data(data_end_day)
          .enter()
          .append("rect")
            .attr('class', 'barplot')
            .attr("x", function(d) { return x(d.continent); })
            .attr("y", function(d) { return y(d.Percentage);})
            .attr("width", x.bandwidth())
            .attr('id', function(d) { return d.continent})
            .attr("height", function(d) { return height - y(d.Percentage); })
            .attr("fill", "#b54a63")
            .on("mouseover", function() {
                d3.select(this).style("fill", "#9b88db");
              })
            .on("mouseout", function() {
                d3.select(this).style("fill", "#b54a63");
              })
            .on("click", continent_to_countries)

            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr('id', 'to_be_deleted_1')
                .attr("y", 6)
                .attr("dy", "-3em")
                .attr("x", 30)
                .attr("dx", "-11em")
                .attr("transform", "rotate(-90)")
                .text("Percentage of covid cases")
                .style("font-weight","bold");

            svg.append("text")
                .text("Shares of covid cases on the last day selected: ")
                .attr("y", - 20)
                .attr('id', "to_be_deleted_1")
                .attr("x", 370)
                .attr('text-anchor', 'middle')
                .style("font-weight","bold");
        }

      function print_barplot_countries(active_data) {
        // set the dimensions and margins of the graph
        var margin = {top: 100, right: 100, bottom: 200, left: 100},
            width = 1000 - margin.left - margin.right,
            height = 800 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#choosing_barplot")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr('id', 'to_be_deleted_2')
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");


        // X axis
        var x = d3.scaleBand()
          .range([ 0, width - margin.left])
          .domain(active_data.map(function(d) { return d.location; }))
          .padding(0.2);
        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "12")
            .style("font-weight","bold");


        var rectangle = svg.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 1000)
          .attr('fill', '#e8e2e1')
          .attr("height", 500)
          .attr('id', 'to_be_deleted_final_1')
          .on('click', go_back_to_continent )

        // Add Y axis
        // compute the max
        let data_end_day = active_data.filter(d => day_end == d.day       &&
                                                   month_end == d.month   &&
                                                   year_end == d.year )
        let my_max = d3.max(data_end_day.map(d => d.Percentage))
        var y = d3.scaleLinear()
          .domain([0, my_max])
          .range([ height, 0]);

        svg.append("g")
          .attr('id', 'to_be_deleted_2')
          .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
          .data(data_end_day)
          .enter()
          .append("rect")
            .attr("x", function(d) { return x(d.location); })
            .attr("y", function(d) { return y(d.Percentage);})
            .attr('class', 'barplot')
            .attr("width", x.bandwidth())
            .attr('id', function(d) { return d.location})
            .attr("height", function(d) { return height - y(d.Percentage); })
            .attr("fill", "#b54a63")
            .on("mouseover", function() {
                d3.select(this).style("fill", "#9b88db");
              })
            .on("mouseout", function() {
                d3.select(this).style("fill", "#b54a63");
              })
            .on("click", add_country)

            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr('id', 'to_be_deleted_2')
                .attr("y", 6)
                .attr("dy", "-3em")
                .attr("x", 30)
                .attr("dx", "-11em")
                .attr("transform", "rotate(-90)")
                .text("Percentage of covid cases")
                .style("font-weight","bold");

            svg.append("text")
                .text("Shares of covid cases on the last day selected: ")
                .attr("y", -20)
                .attr("x", 370)
                .attr('text-anchor', 'middle')
                .style("font-weight","bold");
        }

      function update_dates(){
          if (continent_view) {
            d3.selectAll("#to_be_deleted_1").remove();
            d3.selectAll("#to_be_deleted_2").remove();
            print_barplot(continet_data);
            if (initialization) {
                // pass
            } else {
                table.update()
            }

          } else {
            d3.selectAll("#to_be_deleted_1").remove();
            d3.selectAll("#to_be_deleted_2").remove();
            print_barplot_countries(chosen_continent_data);
            if (initialization) {
                // pass
            } else {
                table.update()
            }
          }
      }

      function continent_to_countries() {
          active_continent = this.id
          new_view = true
          d3.selectAll("#to_be_deleted_1").remove();
          chosen_continent_data = countries_data.filter(
              d => d.continent == active_continent
          )
          continent_view = false
          print_barplot_countries(chosen_continent_data)

      }

      function print_barplot_2() {
        d3.selectAll("#barplot_2").remove();
        // set the dimensions and margins of the graph
        var margin = {top: 100, right: 50, bottom: 50, left: 100},
            width = 900 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#vis1")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr('id', "barplot_2")
            .attr("transform",
                  "translate(" + margin.left + "," + margin.top + ")");

        const color = d3.scaleOrdinal()
          .range(myColours)
        // X axis
        var x = d3.scaleBand()
          .range([ 0, width - margin.left])
          .domain(second_view_data.map(function(d) { return d.iso_code; }))
          .padding(0.2);

        var rectangle = svg.append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 1000)
          .attr('fill', '#e8e2e1')
          .attr("height", 500)
          .attr('id', "barplot_2")


        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .attr('id', "barplot_2")
          .call(d3.axisBottom(x))
          .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "15")
            .style("font-weight","bold")

        // Add Y axis
        // compute the max
        let my_max = d3.max(second_view_data.map(d => d.Percentage_vaccines))
        var y = d3.scaleLinear()
          .domain([0, my_max + 1])
          .range([ height, 0]);

        svg.append("g")
          .attr('id', "barplot_2")
          .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
          .attr('id', "barplot_2")
          .data(second_view_data)
          .enter()
          .append("rect")
            .attr('class', 'barplot')
            .attr("x", function(d) { return x(d.iso_code); })
            .attr("y", function(d) { return y(d.Percentage_vaccines);})
            .attr("width", x.bandwidth())
            .attr('id', function(d) { return d.location})
            .attr("height", function(d) { return height - y(d.Percentage_vaccines); })
            .attr("fill", function(d){ return color(d.location) })
            .on("mouseover", function() {
                d3.select(this).style("fill", "#9b88db");
              })
            .on("mouseout", function() {
                d3.select(this).style("fill", function(d){ return color(d.location) });
              })

            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr('id', "barplot_2")
                .attr("y", 6)
                .attr("dy", "-3em")
                .attr("x", 30)
                .attr("dx", "-3.5em")
                .attr("transform", "rotate(-90)")
                .text("Vaccinations/population (%)")
                .style("font-weight","bold");

            svg.append("text")
                .text("Total vaccination rates on the last day selected: ")
                .attr("y", - 20)
                .attr('id', "barplot_2")
                .attr("x", 370)
                .attr('text-anchor', 'middle')
                .style("font-weight","bold");
        }

      function update_vis_2(){
         // filter the data
         var startDate = new Date(date_start_whole);
         var endDate = new Date(date_end_whole);
         var intermed = countries_data.filter(d => {
                var date = new Date(d["complete_dates"]);
                return (date >= startDate && date <= endDate);
          });

         var data_vis_2 = intermed.filter(d => vect_double.includes(d["location"]))
         var data_to_be_grouped_2 = data_vis_2;

         // get the chosen feature
         var e = document.getElementById("my_select_vis_2");
         var active_feature_2 = e.value;

         // filter the data
         var active_data_2 = data_vis_2.map(function(d) {return {
             active_feature_2: d[active_feature_2],
             complete_dates: d["complete_dates"],
             location: d["location"]
          }})

         const map = new Map(active_data_2.map(({location}) => [location, { location }]));
         active_data_2.forEach((d, i) => map.get(d.location)[d.complete_dates] = d.active_feature_2);
         data_vis_2 = [...map.values()];

         let newData = [];
         data_vis_2.forEach(element => {
            let newsName = element.location;
            delete element.location;

            Object.entries(element).forEach(
                ([key, value], i) => newData.push({
                    location: location,
                    complete_dates: key,
                    active_feature_2: +value
             })
           );
         });

         //The we group then by name:
         let dataByLocation = d3.group(newData, d => d.location);
         dataByLocation = dataByLocation
         console.log(dataByLocation);
         let dataMax = Array.from(newData);

         let oldMax = 0;
         // get the maximum Circulation
         for (var i = 0; i < dataMax.length; i++) {
            var my_max = dataMax[i]["active_feature_2"];
            if (my_max > oldMax) {
                oldMax = my_max;
           }
         }

          // set the dimensions and margins of the graph
          const margin = {top: 10, right: 30, bottom: 30, left: 60},
              width = 700 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

          // remove old vis2
          d3.selectAll("#lineplot_vis2").remove();

          // append the svg object to the body of the page
          const svg = d3.select("#vis2")
            .append("svg")
              .attr('id', 'lineplot_vis2')
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
            .append("g")
              .attr('id', 'lineplot_vis2')
              .attr("transform", `translate(${margin.left},${margin.top})`);

          // group the data: I want to draw one line per group
          const sumstat = d3.group(data_to_be_grouped_2, d => d["location"]);

          console.log(sumstat);

          const x = d3.scaleTime()
            .domain([startDate, endDate])
            .range([0, width]);

          svg.append("g")
              .attr('id', 'lineplot_vis2')
              .attr("transform", `translate(0, ${height})`)
              .classed('x axis', true)
              .call(d3.axisBottom(x).ticks(7));

          // Add Y axis
          const y = d3.scaleLinear()
            .domain([0, oldMax + 1])
            .range([ height, 0 ]);

          svg.append("g")
            .attr('id', 'lineplot_vis2')
            .call(d3.axisLeft(y))

          const color = d3.scaleOrdinal()
            .range(myColours)

            // Draw the line
            svg.selectAll(".line")
                .data(sumstat)
                .join("path")
                    .attr('id', 'lineplot_vis2')
                    .attr("fill", "none")
                    .attr("stroke", function(d){ return color(d[0]) })
                    .attr("stroke-width", 2.5)
                    .attr("d", function(d){
                        return d3.line()
                            .x(function(d) { return x(new Date(d["complete_dates"])); })
                            .y(function(d) { return y(+d[active_feature_2]); })
                            (d[1])
                    })




                  }

      function print_lineplot_2(){
        // create the selector
        var myParent = document.getElementById("selector_space_vis_2");
        var selectList = document.createElement("select");
        selectList.id = "my_select_vis_2";
        // selectList.classList.add('selectpicker');
        myParent.appendChild(selectList);

        for (var i = 0; i < features_vis_2.length; i++) {
          // add the feature selector
          var option = document.createElement("option");
          option.value = features_vis_2[i];
          option.text = features_vis_2[i];
          selectList.appendChild(option);
        }

        myParent.oninput = update_vis_2;

        update_vis_2();
      }

      function add_country(){
          if (first_click) {
            table.selectAll("tr").remove();
            table.create_struct();
            // utils
            first_click = false;
            vect_double.push(this.id)
            table.update();
            max_countries = max_countries + 1

          } else {

              if (vect_double.includes(this.id)) {
                  table.remove();
                  initialize_table();
                  table.reset();
                  for(var i = 0; i < vect_double.length; i++){
                      if (this.id === vect_double[i]) {

                          vect_double.splice(i, 1);
                          i--;
                      }
                  }
                  table.update();
                  max_countries = max_countries - 1
            } else {
                if (max_countries < 10) {
                // data
                vect_double.push(this.id)
                table.update();
                max_countries = max_countries + 1
                }
              }
          }
        }

      function countries_to_continent() {
        active_continent = "None"
        new_view = false
        d3.selectAll("to_be_deleted_2").remove()
        print_barplot(continet_data)
        d3.selectAll("#to_be_deleted_1").remove();
      }

      function go_back_to_continent(){
          continent_view = true
          update_dates()
        }

      function initialize_table(){
          table = d3.select('#choosing_table').append('table');
          var headers = ["Country", "Percentage positives", "Vaccines"];

          // function to handle the data
          table.create_struct = function() {
            table.append("thead").append("tr")
                .selectAll("th")
                .data(headers)
                .enter().append("th")
                .text(function(d) {
                  return d;
                })
                .style("padding", "5px")
                .style("background-color", "lightgrey");
          }

          // Reset the table
          table.reset = function() {
            // recreate the structure
            table.remove();
            initialize_table();
          }

          // update the data_table
          table.update = function(){
            // recreate the structure
            table.selectAll("tr").remove();
            table.create_struct();
            // get the new data saved
            let add_end = countries_data.filter(d => day_end == d.day  &&
                                                       month_end == d.month   &&
                                                       year_end == d.year)
            var selected_data = add_end.filter(d => vect_double.includes(d["location"]))

            table.selectAll("tr").remove();
            table.create_struct();
              // data
              let line = table.append("tbody")
                .selectAll("tr")
                .data(selected_data)
                .enter()
                .append("tr")
                // Highlighting of the line on mouseover
                .on("mouseover", function() {
                    d3.select(this).style("background-color", "pink");
                  })
                .on("mouseout", function() {
                    d3.select(this).style("background-color", "transparent");
                })


                //fill the lines with content
                line.append("td") //Name Cell
                  .text(d => d["location"])
                line.append("td") //Size Cell
                  .text(d => String(d.Percentage.toFixed(2)) + " %")
                line.append("td") //Weight Cell
                  .text(d => String(d.total_vaccinations))

          }
            table.create_struct();
        }

      function update_vis_3(){
        // filter the data
        var intermed = health_data.filter(d => day_end == d.day           &&
                                                   month_end == d.month   &&
                                                   year_end == d.year)

        var data_vis_3 = intermed.filter(d => vect_double.includes(d["location"]))

        // get the chosen feature
        var e = document.getElementById("my_select_vis_3");
        var active_feature_3 = e.value;

        // create the canvas
        let svg = d3.select("#vis3");
        let mapArea = svg.append("g")
            .attr('transform', "translate(30, 30)");

        // preprocessing
        data_vis_3.forEach(d => {
            for (var i = 0; i < features_vis_3.length; i++) {
              d[features_vis_3[i]] = +d[features_vis_3[i]]
            }
        })

        console.log();

        // get a scale for the colour to get max constrast
        let colour_scale_3 = d3.scaleLinear()
            .domain(d3.extent(data_vis_3.map(a => a[active_feature_3])))
            .range([0.9, 0.15]);


        const projection = d3.geoEquirectangular().scale(90);
        const my_path = d3.geoPath(projection);

        mapArea.selectAll("path")
          .data(geodata.features)
          .enter()
          .append("path")
          .attr("d", my_path)

        e.oninput = function() {
          first_click = true

        // create a new map
        let map = mapArea.selectAll("path")
          .data(geodata.features)
          .enter()
          .append('path')
          .attr('d', my_path)
          .attr('stroke', 'darkgrey')
          .attr('stroke-width', 0.5)
          .attr("transform", "scale(0.8)");

        // fill the countries with different colours
        mapArea.selectAll("path")
            .data(data_vis_3)
            .attr('fill', d => colour_generator_3(d[active_feature_3], colour_scale_3))
            .attr('id', d => d["location"])
            .on("mouseover", function() {
                d3.select(this)
                  .attr("fill", "powderblue")
                mapArea.append("text")
                  .text(this.id)
                  .attr("x", d3.pointer(event, svg.node())[0])
                  .attr("y", d3.pointer(event, svg.node())[1])
                  .attr('id', 'flag')
                  .style("font-weight","bold")
                  .style("font-size","20")
                  .attr("fill", "black");
              })

              .on("mouseout", function() {
                  d3.select(this)
                    .attr("fill", d => colour_generator_3(d.HS, colour_scale_3));
                  d3.select("#flag").remove();
              })



              // function that assigns a colour to each state
              function colour_generator_3(d, colour_scale) {
                return d3.hsl(10, 0.7, colour_scale(d))
          }

        }

      e.oninput();}

      function print_map(){
          // create the selector
          var myParent = document.getElementById("selector_space_vis_3");
          var selectList = document.createElement("select");
          selectList.id = "my_select_vis_3";
          // selectList.classList.add('selectpicker');
          myParent.appendChild(selectList);

          for (var i = 0; i < features_vis_3.length; i++) {
            // add the feature selector
            var option = document.createElement("option");
            option.value = features_vis_3[i];
            option.text = features_vis_3[i];
            selectList.appendChild(option);
          }

          myParent.oninput = update_vis_3;

          update_vis_3();
        }



      // button function
      $(document).ready(function () {
            $("#compare_button").click(function (){
                second_view_flag = true
                var sleepTime =$(this).attr('sleepTime');
                setTimeout(function() {
                    d3.selectAll("#choosing_barplot").remove();
                    d3.selectAll("#choosing_table").remove();

                    if (vect_double.length > 0) {
                      // get the data
                      let add_end = countries_data.filter(d => day_end == d.day  &&
                                                                 month_end == d.month   &&
                                                                 year_end == d.year)
                      second_view_data = add_end.filter(d => vect_double.includes(d["location"]))
                      print_barplot_2();
                      print_lineplot_2();
                      print_map();
                    } else {
                        document.write("Please select at least a country.");
                    }


                }, sleepTime);
            });
   });


  })

      var first_click = true


    // function that assigns a colour to each state
    function colour_generator_BA(d, colour_scale) {
      return d3.hsl(11, 0.7, colour_scale(d))
    }


</script>




<style>
  svg{
    width:650;
    height:400;
  }
  .line-class{
    stroke: lightgrey;
    stroke-width: 2;
  }

  .line-info{
    stroke: lightgrey;
    stroke-width: 0.5;
  }

  .grid-container {
      display: grid;
      grid-template-columns: auto auto auto auto;
      background-color: #34eb95;
      padding: 10px;
  }
 </style>


</body>
</html>
